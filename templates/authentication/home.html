{% extends 'authentication/base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="row">
    {% if can_import %}
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h3>Import Excel Data</h3>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="excel_file" class="form-label">Choose Excel File</label>
                        <input type="file" class="form-control" id="excel_file" name="excel_file" accept=".xlsx,.xls" required>
                        <div class="form-text">File must contain Email and Pass columns</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Import Data</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3>Imported Data</h3>
            </div>
            <div class="card-body">
                <table id="dataTable" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Password</th>
                            <th>Trạng thái</th>
                            <th>Thời gian import</th>
                            {% if can_update_status %}
                            <th>Thao tác</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in excel_data %}
                        <tr>
                            <td>{{ item.Email }}</td>
                            <td>{{ item.Pass }}</td>
                            <td class="status-cell" data-record-id="{{ item.id }}">
                                <span class="status-text {% if item.status == 'Chưa sử dụng' %}status-unused
                                                       {% elif item.status == 'Đã đăng ký' %}status-registered
                                                       {% elif item.status == 'Email lỗi' %}status-error
                                                       {% elif item.status == 'Đã kiểm tra' %}status-checked
                                                       {% elif item.status == 'Kiểm tra lỗi' %}status-check-error{% endif %}">
                                    {{ item.status|default:"Chưa sử dụng" }}
                                </span>
                            </td>
                            <td>{{ item.imported_at|slice:":19"|default:"-" }}</td>
                            {% if can_update_status %}
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        Cập nhật trạng thái
                                    </button>
                                    <ul class="dropdown-menu">
                                        {% for status in allowed_status_updates %}
                                        <li><a class="dropdown-item update-status" href="#" data-status="{{ status }}">{{ status }}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Initialize DataTable
        var table = $('#dataTable').DataTable({
            "pageLength": 10,
            "order": [[3, "desc"]], // Sort by import time by default
            "language": {
                "search": "Tìm kiếm:",
                "lengthMenu": "Hiển thị _MENU_ dòng",
                "info": "Hiển thị _START_ đến _END_ của _TOTAL_ dòng",
                "infoEmpty": "Hiển thị 0 đến 0 của 0 dòng",
                "infoFiltered": "(lọc từ _MAX_ dòng)",
                "paginate": {
                    "first": "Đầu",
                    "last": "Cuối",
                    "next": "Sau",
                    "previous": "Trước"
                }
            }
        });

        // Handle status update
        $('.update-status').click(function(e) {
            e.preventDefault();
            var link = $(this);
            var newStatus = link.data('status');
            var cell = link.closest('tr').find('.status-cell');
            var recordId = cell.data('record-id');

            $.ajax({
                url: '{% url "update_status" %}',
                type: 'POST',
                data: {
                    'record_id': recordId,
                    'status': newStatus,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        // Update the status text and class
                        var statusSpan = cell.find('.status-text');
                        statusSpan.text(newStatus);
                        
                        // Remove all status classes and add the appropriate one
                        statusSpan.removeClass('status-unused status-registered status-error status-checked status-check-error');
                        
                        if (newStatus === 'Chưa sử dụng') {
                            statusSpan.addClass('status-unused');
                        } else if (newStatus === 'Đã đăng ký') {
                            statusSpan.addClass('status-registered');
                        } else if (newStatus === 'Email lỗi') {
                            statusSpan.addClass('status-error');
                        } else if (newStatus === 'Đã kiểm tra') {
                            statusSpan.addClass('status-checked');
                        } else if (newStatus === 'Kiểm tra lỗi') {
                            statusSpan.addClass('status-check-error');
                        }
                        
                        // Show success message
                        var alert = $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                    'Cập nhật trạng thái thành công' +
                                    '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                    '</div>');
                        $('.container').first().prepend(alert);
                        
                        // Auto dismiss the alert after 3 seconds
                        setTimeout(function() {
                            alert.alert('close');
                        }, 3000);
                    } else {
                        // Show error message
                        var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                                    'Lỗi: ' + response.message +
                                    '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                    '</div>');
                        $('.container').first().prepend(alert);
                    }
                },
                error: function() {
                    // Show error message
                    var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                                'Có lỗi xảy ra khi cập nhật trạng thái' +
                                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                '</div>');
                    $('.container').first().prepend(alert);
                }
            });
        });
    });
</script>
{% endblock %} 